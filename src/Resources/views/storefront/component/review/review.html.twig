{% sw_extends '@Storefront/storefront/utilities/offcanvas.html.twig' %}

{% block utilities_offcanvas_content %}
	{% block component_review_container %}

		{% set reviewsPerListPage = config('core.listing.reviewsPerPage') %}
		{% if reviewsPerListPage <= 0 %}
			{% set reviewsPerListPage = 10 %}
		{% endif %}

		{% set currentListPage = reviews.page %}

		{% set productReviewCount = reviews.total %}
        {% set totalReviewCount = reviews.matrix.totalReviewCount %}

		{% if totalReviewCount > 0 %}
            {% set productAvgRating = reviews.matrix.averageRating|round(2, 'common') %}
		{% endif %}

		{% set totalReviewsInCurrentLanguage = reviews.totalReviewsInCurrentLanguage ?: productReviewCount %}
		{% set numberOfReviewsNotInCurrentLanguage = productReviewCount - totalReviewsInCurrentLanguage %}

		<div class="product-detail-review tab-pane-container">
			{% block component_review_tab_pane %}
                <div class="row product-detail-review-content js-review-container">


					{% block component_review_main %}
						<div class="col product-detail-review-main js-review-content">
							{% block component_review_alert %}
								{% if ratingSuccess == 1 %}
									{% sw_include '@Storefront/storefront/utilities/alert.html.twig' with {
										type: 'success',
										content: 'detail.reviewFormSuccessAlert'|trans|sw_sanitize
									} %}
                                {% elseif ratingSuccess == 2 %}
                                    {% sw_include '@Storefront/storefront/utilities/alert.html.twig' with {
                                        type: 'success',
                                        content: 'detail.reviewFormSuccessUpdateAlert'|trans|sw_sanitize
                                    } %}
								{% elseif ratingSuccess == -1 %}
									{% sw_include '@Storefront/storefront/utilities/alert.html.twig' with {
										type: 'danger',
										content: 'detail.reviewFormErrorAlert'|trans|sw_sanitize
									} %}
								{% endif %}
							{% endblock %}

							{% block component_review_form_container %}
								<div class="collapse multi-collapse{% if ratingSuccess == -1 %} show{% endif %}"
									 id="review-form">

                                    {% if context.customer and not context.customer.guest %}
										<div class="product-detail-review-form">
											{% sw_include '@Storefront/storefront/component/review/review-form.html.twig' %}
										</div>
									{% else %}
										<div class="product-detail-review-login">
											{% sw_include '@Storefront/storefront/component/review/review-login.html.twig' %}
										</div>
									{% endif %}
								</div>
							{% endblock %}

							{% block component_review_list_container %}
								<div id="review-list"
									 class="collapse multi-collapse product-detail-review-list{% if ratingSuccess != -1 %} show{% endif %}">
                                    {% block component_review_list %}
                                        {% set formAjaxSubmitOptions = {
                                            replaceSelectors: ['.js-review-container'],
                                            submitOnChange: true
                                        } %}

                                        {% block component_review_list_content %}
                                            {% for review in reviews %}
                                                <div class="product-detail-review-list-content">
                                                    {% sw_include '@Storefront/storefront/component/review/review-item.html.twig' %}
                                                </div>
                                            {% endfor %}
                                        {% endblock %}

                                        {% block component_review_list_paging %}

                                            {% set totalPages = (productReviewCount/reviewsPerListPage)|round(0,'ceil') %}

                                            {% if totalPages > 1 %}
                                                {% block component_review_list_paging_form %}
                                                    <div class="product-detail-review-pagination">
                                                        <form class="product-detail-review-pagination-form"
                                                              action="{{ path('frontend.product.reviews', { productId: reviews.productId, parentId: reviews.parentId }) }}"
                                                              method="post"
                                                              data-form-ajax-submit="true"
                                                              data-form-ajax-submit-options="{{ formAjaxSubmitOptions|json_encode }}"
                                                              data-form-ajax-pagination="true">

                                                            <input type="hidden" name="p" value="1">

                                                            {% if app.request.get('language') %}
                                                                <input type="hidden" name="language" value="{{ app.request.get('language') }}">
                                                            {% endif %}

                                                            {% if app.request.get('sort') %}
                                                                <input type="hidden" name="sort" value="{{ app.request.get('sort') }}">
                                                            {% endif %}

                                                            {% if app.request.get('points') %}
                                                                {% for points in app.request.get('points') %}
                                                                    <input type="hidden" name="points[]" value="{{ points }}">
                                                                {% endfor %}
                                                            {% endif %}

                                                            {% sw_include '@Storefront/storefront/component/pagination.html.twig' with {entities: reviews}  %}
                                                        </form>
                                                    </div>
                                                {% endblock %}
                                            {% endif %}
                                        {% endblock %}
                                    {% endblock %}

                                    {% if productReviewCount <= 0 %}
                                        {% block component_review_list_empty %}
                                            {% sw_include '@Storefront/storefront/utilities/alert.html.twig' with {
                                                type: 'info',
                                                content: 'detail.reviewListEmpty'|trans|sw_sanitize
                                            } %}
                                        {% endblock %}
                                    {% endif %}
								</div>
							{% endblock %}
						</div>
					{% endblock %}

                    {% block component_review_form_teaser %}
                        <div class="product-detail-review-teaser text-center js-review-teaser">
                            {% block component_review_form_teaser_header %}
                                <p class="h3">
                                    {% if not reviews.customerReview %}
                                        {{ 'detail.reviewTeaserTitle'|trans|sw_sanitize }}
                                    {% else %}
                                        {{ 'detail.reviewExistsTeaserTitle'|trans|sw_sanitize }}
                                    {% endif %}
                                </p>
                            {% endblock %}

                            {% block component_review_form_teaser_text %}
                                <p class="h4 fw-normal">
                                    {% if not page.customerReview %}
                                        {{ 'detail.reviewTeaserText'|trans|sw_sanitize }}
                                    {% else %}
                                        {{ 'detail.reviewExistsTeaserText'|trans|sw_sanitize }}
                                    {% endif %}
                                </p>
                            {% endblock %}

                            {% block component_review_form_teaser_button %}
                                <button class="btn btn-primary w-100 product-detail-review-teaser-btn"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target=".multi-collapse"
                                        aria-expanded="false"
                                        aria-controls="review-form review-list">
                        <span class="product-detail-review-teaser-show text-uppercase">
							{% if not reviews.customerReview %}
                                {{ 'detail.reviewTeaserButton'|trans|sw_sanitize }}
                            {% else %}
                                {{ 'detail.reviewExistsTeaserButton'|trans|sw_sanitize }}
                            {% endif %}
						</span>
                                    <span class="product-detail-review-teaser-hide text-uppercase">
							{{ 'detail.reviewTeaserButtonHide'|trans|sw_sanitize }}
						</span>
                                </button>
                            {% endblock %}
                        </div>
                    {% endblock %}
				</div>
			{% endblock %}
		</div>
	{% endblock %}
{% endblock %}
